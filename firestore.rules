rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to validate inspection data
    function isValidInspection() {
      let data = request.resource.data;
      return data.truckNumber is string
        && data.truckNumber.size() > 0
        && data.truckNumber.size() <= 50
        && data.status in ['in-progress', 'complete', 'gone']
        && data.inspector1 is string
        && data.inspector1.size() > 0;
    }
    
    // Helper function to validate inspector data
    function isValidInspector() {
      let data = request.resource.data;
      return data.name is string
        && data.name.size() > 0
        && data.name.size() <= 100
        && data.isAdmin is bool
        && data.active is bool;
    }
    
    // Inspectors collection
    // Note: Full authentication will be added in Phase 2
    // Currently allows read for all users (needed for inspector selection)
    // Write is restricted to prevent client-side modifications
    match /inspectors/{inspectorId} {
      allow read: if true;
      // Write operations should only be done via admin scripts or Firebase Console
      // This prevents malicious client-side modifications
      allow write: if false;
    }
    
    // Inspections collection
    // Note: Full authentication will be added in Phase 2
    match /inspections/{inspectionId} {
      // Allow read for viewing inspections
      allow read: if true;
      // Allow create with validation
      allow create: if isValidInspection();
      // Allow update for in-progress inspections only
      allow update: if resource.data.status == 'in-progress'
        || (resource.data.status != 'in-progress' && request.resource.data.status == resource.data.status);
      // Prevent deletion from client
      allow delete: if false;
    }
  }
}
