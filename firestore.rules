rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to validate inspection data on create
    function isValidInspection() {
      let data = request.resource.data;
      return data.truckNumber is string
        && data.truckNumber.size() > 0
        && data.truckNumber.size() <= 50
        // Truck number must be alphanumeric, dashes, or spaces (validated client-side with regex)
        && data.truckNumber.matches('^[A-Z0-9\\-\\s]+$')
        && data.status in ['in-progress', 'complete', 'gone']
        && data.inspector1 is string
        && data.inspector1.size() > 0;
    }
    
    // Helper function to check if inspection is still editable
    function isInProgressInspection() {
      return resource.data.status == 'in-progress';
    }
    
    // Helper function to check if status change is prevented
    // Once completed/gone, status cannot be changed
    function statusNotChanged() {
      return request.resource.data.status == resource.data.status;
    }
    
    // Helper function to validate email recipient data
    function isValidEmailRecipient() {
      let data = request.resource.data;
      return data.name is string
        && data.name.size() > 0
        && data.name.size() <= 100
        && data.email is string
        && data.email.size() > 0
        && data.email.size() <= 254;
    }
    
    // Inspectors collection
    // Read: Allow authenticated users to read inspectors
    // Write: Only through Cloud Functions (admin-only operations)
    match /inspectors/{inspectorId} {
      allow read: if isAuthenticated();
      // Allow writes only for authenticated users
      // Admin validation is done in Cloud Functions
      allow write: if isAuthenticated();
    }
    
    // Email recipients collection
    // Read/Write: Require authentication
    match /emailRecipients/{recipientId} {
      allow read: if isAuthenticated();
      // Allow create with validation
      allow create: if isAuthenticated() && isValidEmailRecipient();
      // Allow updates and deletes for authenticated users
      allow update, delete: if isAuthenticated();
    }
    
    // Inspections collection
    // Require authentication for all operations
    match /inspections/{inspectionId} {
      // Allow read for authenticated users
      allow read: if isAuthenticated();
      // Allow create with validation
      allow create: if isAuthenticated() && isValidInspection();
      // Allow updates with these conditions:
      // 1. If inspection is still in-progress, allow any updates
      // 2. If inspection is completed/gone, only allow updates that don't change status
      allow update: if isAuthenticated() && (isInProgressInspection() || statusNotChanged());
      // Prevent deletion from client - data integrity is important
      allow delete: if false;
    }
  }
}
